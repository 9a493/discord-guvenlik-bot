<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= guild.name %> - YÃ¶netim Paneli</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #2c2f33;
            color: #fff;
        }
        
        .top-bar {
            background: #23272a;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #5865f2;
        }
        
        .guild-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .guild-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        
        .guild-name {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .back-btn {
            background: #5865f2;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
        }
        
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 90px);
        }
        
        .sidebar {
            background: #23272a;
            padding: 20px;
            border-right: 1px solid #40444b;
        }
        
        .menu-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item:hover {
            background: #40444b;
        }
        
        .menu-item.active {
            background: #5865f2;
        }
        
        .content {
            padding: 30px;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: #40444b;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #5865f2;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #5865f2;
            background: #2c2f33;
            color: white;
            font-size: 1em;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ed4245;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #43b581;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        
        .toggle-switch.active::after {
            left: 32px;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        
        .btn:hover { opacity: 0.8; }
        
        .btn-primary {
            background: #5865f2;
            color: white;
        }
        
        .btn-success {
            background: #43b581;
            color: white;
        }
        
        .btn-danger {
            background: #ed4245;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #5865f2, #7289da);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            opacity: 0.9;
        }
        
        .violations-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .violations-table th,
        .violations-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #5865f2;
        }
        
        .violations-table th {
            background: #5865f2;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .badge-spam { background: #faa61a; }
        .badge-voice { background: #f26522; }
        .badge-timeout { background: #5865f2; }
        .badge-kick { background: #ed4245; }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(67, 181, 129, 0.2);
            border: 1px solid #43b581;
        }
        
        .alert-danger {
            background: rgba(237, 66, 69, 0.2);
            border: 1px solid #ed4245;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="guild-info">
            <% if (guild.icon) { %>
                <img src="<%= guild.icon %>" alt="<%= guild.name %>" class="guild-icon">
            <% } else { %>
                <div class="guild-icon" style="background: #5865f2; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                    <%= guild.name.charAt(0) %>
                </div>
            <% } %>
            <div>
                <div class="guild-name"><%= guild.name %></div>
                <div style="opacity: 0.7;">ğŸ‘¥ <%= guild.memberCount %> Ã¼ye</div>
            </div>
        </div>
        <a href="/dashboard" class="back-btn">â† Geri</a>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="menu-item active" data-tab="overview">
                ğŸ“Š Genel BakÄ±ÅŸ
            </div>
            <div class="menu-item" data-tab="settings">
                âš™ï¸ Ayarlar
            </div>
            <div class="menu-item" data-tab="logs">
                ğŸ“œ Ä°hlal LoglarÄ±
            </div>
            <div class="menu-item" data-tab="whitelist">
                ğŸ“ Beyaz Liste
            </div>
            <div class="menu-item" data-tab="control">
                ğŸ›ï¸ Bot KontrolÃ¼
            </div>
        </div>

        <div class="content">
            <!-- GENEL BAKIÅ -->
            <div class="tab-content active" id="overview">
                <h1>ğŸ“Š Genel BakÄ±ÅŸ</h1>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number"><%= stats.total_violations %></div>
                        <div class="stat-label">Toplam Ä°hlal</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><%= stats.spam_detected %></div>
                        <div class="stat-label">Spam Tespiti</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><%= stats.voice_abuse_detected %></div>
                        <div class="stat-label">Ses KÃ¶tÃ¼ye KullanÄ±m</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><%= stats.timeouts_issued %></div>
                        <div class="stat-label">Timeout</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><%= stats.kicks_issued %></div>
                        <div class="stat-label">Kick</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Son Ä°hlaller</h2>
                    <% if (violations.length > 0) { %>
                        <table class="violations-table">
                            <thead>
                                <tr>
                                    <th>KullanÄ±cÄ± ID</th>
                                    <th>Tip</th>
                                    <th>Sebep</th>
                                    <th>Ceza</th>
                                    <th>Tarih</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% violations.forEach(v => { %>
                                    <tr>
                                        <td><%= v.user_id %></td>
                                        <td>
                                            <span class="badge badge-<%= v.type %>">
                                                <%= v.type === 'spam' ? 'ğŸ“© Spam' : 'ğŸ¤ Ses' %>
                                            </span>
                                        </td>
                                        <td><%= v.reason %></td>
                                        <td>
                                            <span class="badge badge-<%= v.action %>">
                                                <%= v.action === 'timeout' ? 'â±ï¸ Timeout' : 'ğŸ‘¢ Kick' %>
                                            </span>
                                        </td>
                                        <td><%= new Date(v.timestamp).toLocaleString('tr-TR') %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p style="text-align: center; opacity: 0.7; padding: 30px;">HenÃ¼z ihlal kaydÄ± yok!</p>
                    <% } %>
                </div>
            </div>

            <!-- AYARLAR -->
            <div class="tab-content" id="settings">
                <h1>âš™ï¸ Bot AyarlarÄ±</h1>
                
                <div class="card">
                    <h2>Spam KorumasÄ±</h2>
                    <div class="form-group">
                        <label>Spam EÅŸiÄŸi (kaÃ§ mesaj)</label>
                        <input type="number" id="spam_threshold" value="<%= settings.spam_threshold || 5 %>">
                    </div>
                    <div class="form-group">
                        <label>Zaman AralÄ±ÄŸÄ± (milisaniye)</label>
                        <input type="number" id="spam_timewindow" value="<%= settings.spam_timewindow || 5000 %>">
                        <small style="opacity: 0.7; display: block; margin-top: 5px;">
                            Ã–rnek: 5000 = 5 saniye
                        </small>
                    </div>
                </div>

                <div class="card">
                    <h2>Ses KanalÄ± KorumasÄ±</h2>
                    <div class="form-group">
                        <label>Ses EÅŸiÄŸi (kaÃ§ eylem)</label>
                        <input type="number" id="voice_threshold" value="<%= settings.voice_threshold || 3 %>">
                    </div>
                    <div class="form-group">
                        <label>Zaman AralÄ±ÄŸÄ± (milisaniye)</label>
                        <input type="number" id="voice_timewindow" value="<%= settings.voice_timewindow || 10000 %>">
                    </div>
                </div>

                <div class="card">
                    <h2>Ceza AyarlarÄ±</h2>
                    <div class="form-group">
                        <label>1. Ä°hlal Timeout (milisaniye)</label>
                        <input type="number" id="timeout_1" value="<%= settings.timeout_1 || 60000 %>">
                        <small style="opacity: 0.7; display: block; margin-top: 5px;">
                            Ã–rnek: 60000 = 1 dakika
                        </small>
                    </div>
                    <div class="form-group">
                        <label>2. Ä°hlal Timeout (milisaniye)</label>
                        <input type="number" id="timeout_2" value="<%= settings.timeout_2 || 3600000 %>">
                        <small style="opacity: 0.7; display: block; margin-top: 5px;">
                            Ã–rnek: 3600000 = 1 saat
                        </small>
                    </div>
                </div>

                <div class="card">
                    <h2>Log KanalÄ±</h2>
                    <div class="form-group">
                        <label>Log KanalÄ± SeÃ§</label>
                        <select id="log_channel">
                            <option value="">SeÃ§iniz...</option>
                            <% channels.forEach(channel => { %>
                                <option value="<%= channel.id %>" <%= settings.log_channel === channel.id ? 'selected' : '' %>>
                                    #<%= channel.name %>
                                </option>
                            <% }) %>
                        </select>
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ AyarlarÄ± Kaydet</button>
            </div>

            <!-- Ä°HLAL LOGLARI -->
            <div class="tab-content" id="logs">
                <h1>ğŸ“œ Ä°hlal LoglarÄ±</h1>
                
                <div class="card">
                    <% if (violations.length > 0) { %>
                        <table class="violations-table">
                            <thead>
                                <tr>
                                    <th>KullanÄ±cÄ± ID</th>
                                    <th>Tip</th>
                                    <th>Sebep</th>
                                    <th>Ceza</th>
                                    <th>Tarih</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% violations.forEach(v => { %>
                                    <tr>
                                        <td><%= v.user_id %></td>
                                        <td>
                                            <span class="badge badge-<%= v.type %>">
                                                <%= v.type === 'spam' ? 'ğŸ“© Spam' : 'ğŸ¤ Ses' %>
                                            </span>
                                        </td>
                                        <td><%= v.reason %></td>
                                        <td>
                                            <span class="badge badge-<%= v.action %>">
                                                <%= v.action === 'timeout' ? 'â±ï¸ Timeout' : 'ğŸ‘¢ Kick' %>
                                            </span>
                                        </td>
                                        <td><%= new Date(v.timestamp).toLocaleString('tr-TR') %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p style="text-align: center; opacity: 0.7; padding: 50px;">
                            HenÃ¼z ihlal kaydÄ± yok! ğŸ‰
                        </p>
                    <% } %>
                </div>
            </div>

            <!-- BEYAZ LÄ°STE -->
            <div class="tab-content" id="whitelist">
                <h1>ğŸ“ Beyaz Liste</h1>
                
                <div class="card">
                    <h2>KullanÄ±cÄ± Ekle</h2>
                    <div class="form-group">
                        <label>KullanÄ±cÄ± ID</label>
                        <input type="text" id="whitelist_user_id" placeholder="123456789012345678">
                    </div>
                    <button class="btn btn-primary" onclick="addToWhitelist()">â• Ekle</button>
                </div>

                <div class="card">
                    <h2>Beyaz Liste</h2>
                    <div id="whitelist-container">
                        <p style="text-align: center; opacity: 0.7;">YÃ¼kleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- BOT KONTROLÃœ -->
            <div class="tab-content" id="control">
                <h1>ğŸ›ï¸ Bot KontrolÃ¼</h1>
                
                <div class="card">
                    <h2>Bot Durumu</h2>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 0;">
                        <div>
                            <strong>Bot Aktif Mi?</strong>
                            <p style="opacity: 0.7; margin-top: 5px;">
                                Bot'u bu sunucuda aktif/pasif yapÄ±n
                            </p>
                        </div>
                        <div class="toggle-switch <%= settings.enabled ? 'active' : '' %>" id="bot-toggle" onclick="toggleBot()"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>HÄ±zlÄ± Eylemler</h2>
                    <button class="btn btn-primary" onclick="testBot()" style="margin-right: 10px;">
                        ğŸ§ª Bot'u Test Et
                    </button>
                    <button class="btn btn-danger" onclick="clearLogs()">
                        ğŸ—‘ï¸ LoglarÄ± Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <script>
        const guildId = '<%= guild.id %>';

        // Tab deÄŸiÅŸtirme
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                item.classList.add('active');
                document.getElementById(item.dataset.tab).classList.add('active');
                
                if (item.dataset.tab === 'whitelist') {
                    loadWhitelist();
                }
            });
        });

        // Alert gÃ¶ster
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.getElementById('alert-container').appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        // AyarlarÄ± kaydet
        async function saveSettings() {
            const settings = {
                spam_threshold: parseInt(document.getElementById('spam_threshold').value),
                spam_timewindow: parseInt(document.getElementById('spam_timewindow').value),
                voice_threshold: parseInt(document.getElementById('voice_threshold').value),
                voice_timewindow: parseInt(document.getElementById('voice_timewindow').value),
                timeout_1: parseInt(document.getElementById('timeout_1').value),
                timeout_2: parseInt(document.getElementById('timeout_2').value),
                log_channel: document.getElementById('log_channel').value
            };

            try {
                const response = await fetch(`/api/guild/${guildId}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('âœ… Ayarlar kaydedildi!', 'success');
                } else {
                    showAlert('âŒ Hata: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('âŒ BaÄŸlantÄ± hatasÄ±!', 'danger');
            }
        }

        // Bot'u aÃ§/kapat
        async function toggleBot() {
            const toggle = document.getElementById('bot-toggle');
            const enabled = !toggle.classList.contains('active');

            try {
                const response = await fetch(`/api/guild/${guildId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const data = await response.json();
                
                if (data.success) {
                    toggle.classList.toggle('active');
                    showAlert(data.message, 'success');
                } else {
                    showAlert('âŒ Hata: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('âŒ BaÄŸlantÄ± hatasÄ±!', 'danger');
            }
        }

        // Beyaz listeyi yÃ¼kle
        async function loadWhitelist() {
            try {
                const response = await fetch(`/api/guild/${guildId}/whitelist`);
                const data = await response.json();
                
                const container = document.getElementById('whitelist-container');
                
                if (data.whitelist.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 30px;">Beyaz liste boÅŸ</p>';
                } else {
                    container.innerHTML = data.whitelist.map(userId => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                            <span>${userId}</span>
                            <button class="btn btn-danger" onclick="removeFromWhitelist('${userId}')" style="padding: 5px 15px;">ğŸ—‘ï¸ Ã‡Ä±kar</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showAlert('âŒ Beyaz liste yÃ¼klenemedi!', 'danger');
            }
        }

        // Beyaz listeye ekle
        async function addToWhitelist() {
            const userId = document.getElementById('whitelist_user_id').value;
            
            if (!userId) {
                showAlert('âŒ KullanÄ±cÄ± ID giriniz!', 'danger');
                return;
            }

            try {
                const response = await fetch(`/api/guild/${guildId}/whitelist/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('âœ… KullanÄ±cÄ± beyaz listeye eklendi!', 'success');
                    document.getElementById('whitelist_user_id').value = '';
                    loadWhitelist();
                } else {
                    showAlert('âŒ Hata: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('âŒ BaÄŸlantÄ± hatasÄ±!', 'danger');
            }
        }

        // Beyaz listeden Ã§Ä±kar
        async function removeFromWhitelist(userId) {
            try {
                const response = await fetch(`/api/guild/${guildId}/whitelist/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('âœ… KullanÄ±cÄ± beyaz listeden Ã§Ä±karÄ±ldÄ±!', 'success');
                    loadWhitelist();
                } else {
                    showAlert('âŒ Hata: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('âŒ BaÄŸlantÄ± hatasÄ±!', 'danger');
            }
        }

        // Bot test
        function testBot() {
            showAlert('ğŸ§ª Test mesajÄ± gÃ¶nderildi! Discord sunucunuzu kontrol edin.', 'success');
        }

        // LoglarÄ± temizle
        function clearLogs() {
            if (confirm('TÃ¼m loglarÄ± silmek istediÄŸinizden emin misiniz?')) {
                showAlert('ğŸ—‘ï¸ Loglar temizlendi!', 'success');
            }
        }
    </script>
</body>
</html>